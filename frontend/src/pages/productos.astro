---
// **VERIFICA ESTE NOMBRE:** Asegúrate de que 'MainLayout.astro' es el nombre correcto de tu layout principal.
// Si tu layout principal se llama 'Layout.astro' (sin "Main"), cámbialo a:
// import Layout from '../layouts/Layout.astro';
import MainLayout from '../layouts/MainLayout.astro';
import ProductCard from '../components/ProductCard.astro';
import CategoryFilter from '../components/CategoryFilter.astro'; // Componente de filtro de categoría

// --- LÓGICA DE FILTRADO Y BÚSQUEDA ---
const url = new URL(Astro.request.url);
const selectedCategory = url.searchParams.get('category') || '';
const searchTerm = url.searchParams.get('search') || ''; // <-- ¡NUEVO! Obtenemos el término de búsqueda

// Datos de productos de prueba (mock data)
// ¡¡ESTAS RUTAS YA ESTÁN ACTUALIZADAS CON LAS TUYAS!!
const allProducts = [
  { id: 1, title: 'Camiseta de Fútbol Clásica', category: 'Camisetas', price: 29.99, imageUrl: '/src/assets/camiseta-barcelona.jpg' },
  { id: 2, title: 'Jeans Slim Fit Azules', category: 'Pantalones', price: 45.50, imageUrl: '/src/assets/Jeans-azul.png', discountPercentage: 10 },
  { id: 3, title: 'Sudadera con Capucha Cómoda', category: 'Sudaderas', price: 35.00, imageUrl: '/src/assets/sudadera-capucha.png' },
  { id: 4, title: 'Zapatillas Adidas Yeezy Boost', category: 'Calzado', price: 69.95, imageUrl: '/src/assets/Zapatillas-Adidas-Yeezy-Boost.png', discountPercentage: 25 },
  { id: 5, title: 'Vestido de Verano Floral', category: 'Vestidos', price: 52.75, imageUrl: '/src/assets/Vestido de Verano Floral.jpg' },
  { id: 6, title: 'Gorra de Béisbol Negra', category: 'Accesorios', price: 12.00, imageUrl: '/src/assets/Gorra de Béisbol Negra.jpg' },
  { id: 7, title: 'Chaqueta de Cuero Elegante', category: 'Chaquetas', price: 120.00, imageUrl: '/src/assets/Chaqueta de Cuero Elegante.jpg', discountPercentage: 15 },
  { id: 8, title: 'Falda Midi Plisada', category: 'Faldas', price: 38.25, imageUrl: '/src/assets/Falda Midi Plisada.jpg' },
  // Añade más productos si quieres, y asegúrate de darles una 'category'
];

// Obtenemos una lista única de categorías para el filtro
const categories = Array.from(new Set(allProducts.map(p => p.category)));

// Filtramos los productos por categoría Y por término de búsqueda
let filteredProducts = allProducts;

if (selectedCategory) {
  filteredProducts = filteredProducts.filter(product => product.category === selectedCategory);
}

if (searchTerm) {
  const lowerCaseSearchTerm = searchTerm.toLowerCase();
  filteredProducts = filteredProducts.filter(product =>
    product.title.toLowerCase().includes(lowerCaseSearchTerm)
  );
}

// --- DETERMINAR SI ES UNA PETICIÓN HTMX ---
const isHxRequest = Astro.request.headers.get('HX-Request') === 'true';

if (isHxRequest) {
  return Astro.html`
    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 p-4 sm:p-8 max-w-7xl mx-auto">
      ${filteredProducts.length > 0 ? filteredProducts.map(product => Astro.renderComponent(ProductCard, {
          title: product.title,
          price: product.price,
          imageUrl: product.imageUrl,
          discountPercentage: product.discountPercentage
      })) : '<p class="text-center text-gray-600 col-span-full">No se encontraron productos que coincidan con los criterios de búsqueda o filtro.</p>'}
    </div>
  `;
}
---

<MainLayout title="Catálogo de Productos - StyleHub">
  <h1 class="text-4xl sm:text-5xl font-extrabold text-center my-10 text-gray-900 leading-tight">
    Explora Nuestra Colección
  </h1>
  <p class="text-center text-gray-600 mb-12 max-w-2xl mx-auto">
    Descubre las últimas tendencias y encuentra tu estilo ideal en nuestra amplia selección de ropa.
  </p>

  <div class="max-w-7xl mx-auto px-4 sm:px-8 mb-8 flex flex-col sm:flex-row gap-4">
    <div class="flex-1">
      <CategoryFilter categories={categories} selectedCategory={selectedCategory} />
    </div>

    <div class="flex-1 p-4 bg-gray-50 rounded-lg shadow-sm">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Buscar Productos</h2>
      <input
        type="text"
        name="search"
        placeholder="Buscar por nombre..."
        value={searchTerm}
        class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-gray-700"
        hx-get="/productos"         // Cuando el input cambia, hace una petición GET a /productos
        hx-target="#product-list"   // El resultado de la petición reemplazará el contenido del div con id="product-list"
        hx-trigger="keyup changed delay:500ms" // Dispara después de escribir y una pausa de 500ms
        hx-indicator="#search-indicator" // Muestra un indicador de carga (lo crearemos abajo)
        hx-push-url="true"          // Actualiza la URL
      >
      <div id="search-indicator" class="htmx-indicator mt-2 text-sm text-gray-500">
        Buscando...
      </div>
    </div>
  </div>

  <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 p-4 sm:p-8 max-w-7xl mx-auto">
    {filteredProducts.length > 0 ? filteredProducts.map(product => (
      <ProductCard
        title={product.title}
        price={product.price}
        imageUrl={product.imageUrl}
        discountPercentage={product.discountPercentage}
      />
    )) : <p class="text-center text-gray-600 col-span-full">No se encontraron productos que coincidan con los criterios de búsqueda o filtro.</p>}
  </div>
</MainLayout>